<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>SSE èŠå¤©ï¼ˆæ”¯æŒå›¾ç‰‡ï¼‰</title>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // é…ç½® markedï¼šæ³¨æ„ breaks è®¾ä¸º falseï¼Œå› ä¸ºæˆ‘ä»¬è‡ªå·±å¤„ç†æ¢è¡Œ
        marked.setOptions({
            gfm: true,
            breaks: false,
            renderer: new marked.Renderer()
        });
    </script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            gap: 10px;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #eaeaea;
        }

        .message-content p {
            margin: 1em 0;
            line-height: 1.6;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            line-height: 1.5;
        }

        .user-message {
            background: #e3f2fd;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            text-align: right;
        }

        .bot-message {
            background: #f1f8e9;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
            text-align: right;
        }

        .loading {
            color: #888;
            font-style: italic;
        }

        .input-area {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #eaeaea;
            align-items: center;
        }

        .input-area input[type="text"], .input-area textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            height: 40px; /* ç»Ÿä¸€é«˜åº¦ */
        }

        .upload-btn {
            padding: 12px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
        }

        .upload-btn:hover {
            background: #e0e0e0;
        }

        #imageUpload {
            display: none;
        }

        .send-btn {
            background: #1890ff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            height: fit-content;
        }

        .send-btn:hover {
            background: #40a9ff;
        }

        .image-preview-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-right: 4px;
            margin-top: 4px;
        }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="messages" id="messages"></div>

    <div class="input-area">
        <input id="userId" placeholder="ç”¨æˆ· ID" style="width: 120px;" type="text" value="10001"/>
        <textarea id="userInput" placeholder="è¯·è¾“å…¥..."></textarea>

        <!-- å›¾ç‰‡ä¸Šä¼  -->
        <label class="upload-btn" for="imageUpload">ğŸ“·</label>
        <input accept="image/*" id="imageUpload" multiple type="file"/>

        <button class="send-btn" onclick="sendMessage()">å‘é€</button>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
    <div id="imagePreview" style="margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;"></div>
</div>

<script>
    let conversationId = generateUUID();
    const messagesDiv = document.getElementById('messages');
    let selectedImageFiles = []; // å­˜æ”¾é€‰ä¸­çš„ File å¯¹è±¡
    const previewContainer = document.getElementById('imagePreview');

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function formatTime(date) {
        return date.toLocaleTimeString('zh-CN', {hour12: false});
    }

    function addMessage(htmlContent, isUser, time) {
        const msg = document.createElement('div');
        msg.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

        const contentDiv = document.createElement('div');
        contentDiv.innerHTML = htmlContent;

        const timeEl = document.createElement('div');
        timeEl.className = 'message-time';
        timeEl.textContent = time;

        msg.appendChild(contentDiv);
        msg.appendChild(timeEl);
        messagesDiv.appendChild(msg);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return msg;
    }

    // ç›‘å¬æ–‡ä»¶é€‰æ‹©
    document.getElementById('imageUpload').addEventListener('change', function (e) {
        selectedImageFiles.push(...Array.from(e.target.files));
        renderImagePreview();
    });

    // æ¸²æŸ“å›¾ç‰‡é¢„è§ˆ
    function renderImagePreview() {
        previewContainer.innerHTML = ''; // æ¸…ç©º

        selectedImageFiles.forEach((file, index) => {
            const url = URL.createObjectURL(file);
            const img = document.createElement('img');
            img.src = url;
            img.className = 'image-preview-thumb';
            img.title = file.name;

            // åˆ é™¤æŒ‰é’®
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Ã—';
            delBtn.style.marginLeft = '4px';
            delBtn.style.background = '#f44336';
            delBtn.style.color = 'white';
            delBtn.style.border = 'none';
            delBtn.style.borderRadius = '50%';
            delBtn.style.width = '16px';
            delBtn.style.height = '16px';
            delBtn.style.cursor = 'pointer';
            delBtn.onclick = () => {
                selectedImageFiles.splice(index, 1);
                renderImagePreview(); // é‡æ–°æ¸²æŸ“
            };

            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.alignItems = 'center';

            container.appendChild(img);
            container.appendChild(delBtn);
            previewContainer.appendChild(container);
        });
    }

    async function sendMessage() {
        const userId = document.getElementById('userId').value.trim();
        const userInput = document.getElementById('userInput').value.trim();

        if (!userId) {
            alert('è¯·è¾“å…¥ç”¨æˆ· ID');
            return;
        }
        if (!userInput && selectedImageFiles.length === 0) {
            alert('è¯·è¾“å…¥æ¶ˆæ¯æˆ–é€‰æ‹©å›¾ç‰‡');
            return;
        }

        // æ„å»ºç”¨æˆ·æ¶ˆæ¯ HTMLï¼ˆå«å›¾ç‰‡é¢„è§ˆï¼‰
        let userHtml = userInput.replace(/\n/g, '<br>');
        if (selectedImageFiles.length > 0) {
            userHtml += '<div style="margin-top: 6px;">';
            selectedImageFiles.forEach(file => {
                const url = URL.createObjectURL(file);
                userHtml += `<img src="${url}" class="image-preview-thumb" title="${file.name}">`;
            });
            userHtml += '</div>';
        }

        const now = new Date();
        addMessage(userHtml, true, formatTime(now));
        document.getElementById('userInput').value = '';
        document.getElementById('imageUpload').value = '';

        const loadingMsg = addMessage('æ­£åœ¨è¾“å…¥...', false, formatTime(new Date()));

        try {
            // æ„å»º FormDataï¼ˆå…³é”®ï¼ï¼‰
            const formData = new FormData();
            formData.append('conversationId', conversationId);
            formData.append('userInput', userInput);
            selectedImageFiles.forEach(file => {
                formData.append('images', file); // å­—æ®µåå¿…é¡»æ˜¯ "images"
            });

            const response = await fetch('http://127.0.0.1:9999/chat/stream', {
                method: 'POST',
                headers: {
                    'x-userId': userId
                    // âš ï¸ ä¸è¦è®¾ç½® Content-Typeï¼è®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½® multipart
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            }

            // SSE æµå¤„ç†ï¼ˆå’Œä¹‹å‰ä¸€è‡´ï¼‰
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let botMessage = '';
            let botMsgElement = null;

            loadingMsg.remove();

            while (true) {
                const {done, value} = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, {stream: true});
                const lines = buffer.split('\n');
                buffer = lines[lines.length - 1];
                const completeLines = lines.slice(0, -1);

                for (const line of completeLines) {
                    if (line.startsWith('data:')) {
                        let text = line.substring(5).trim();
                        if (text !== '') {
                            // è¿˜åŸå¹¶æ ‡å‡†åŒ–æ¢è¡Œ
                            text = text.replace(/\[NEWLINE\]/g, '\n')
                                .replace(/\n\n/g, '<br><br>')
                                .replace(/\n/g, '<br>');

                            botMessage += text;

                            if (!botMsgElement) {
                                botMsgElement = addMessage('', false, formatTime(new Date()));
                            }

                            const contentDiv = botMsgElement.querySelector('div:not(.message-time)');
                            if (contentDiv) {
                                contentDiv.innerHTML = marked.parse(botMessage);
                            }

                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        }
                    }
                }
            }

            // æ¸…ç©ºå·²é€‰å›¾ç‰‡
            selectedImageFiles = [];
            previewContainer.innerHTML = ''; // æ¸…ç©ºé¢„è§ˆåŒº

        } catch (error) {
            console.error('Error:', error);
            addMessage(`[é”™è¯¯] ${error.message}`, false, formatTime(new Date()));
        }
    }

    document.getElementById('userInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
</script>

</body>
</html>